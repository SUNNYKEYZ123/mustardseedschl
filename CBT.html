<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBT Exam Application</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM CDNs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel CDN for JSX transformation in browser (NOT for production) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase CDNs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase modules to the global scope for the Babel script
        window.firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, addDoc, getDocs, doc, deleteDoc, onSnapshot, query, where };
    </script>

    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        /* Simple fade-in animation */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }
        .animate-fade-in-down {
            animation: fadeInDown 0.8s ease-out forwards;
        }
    </style>
</head>
<body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root">
        <!-- Your React app will render here -->
    </div>

    <script type="text/babel">
        // Access Firebase modules from the global scope
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, addDoc, getDocs, doc, deleteDoc, onSnapshot, query, where } = window.firebase;

        // Create a context for Firebase services and user data
        const AppContext = React.createContext(null);

        // Helper to map option index to letter (A, B, C, D)
        const optionLetters = ['A', 'B', 'C', 'D'];

        // Admin Password (hardcoded for this example as per request)
        const ADMIN_PASSWORD = 'SUNNYKEYZ2025@';

        // Modal Component for alerts and confirmations
        const Modal = ({ message, onConfirm, onCancel, showCancel = false }) => {
          if (!message) return null;

          return (
            <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-xl shadow-lg p-6 max-w-sm w-full border border-gray-200">
                <p className="text-gray-800 text-lg font-semibold mb-6 text-center">{message}</p>
                <div className="flex justify-center space-x-4">
                  {showCancel && (
                    <button
                      onClick={onCancel}
                      className="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition duration-200 ease-in-out"
                    >
                      Cancel
                    </button>
                  )}
                  <button
                    onClick={onConfirm}
                    className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-300 ease-in-out"
                  >
                    OK
                  </button>
                </div>
              </div>
            </div>
          );
        };

        // Home Page Component
        const HomePage = () => {
          const { setCurrentPage, userId } = React.useContext(AppContext);

          return (
            <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
              <div className="bg-white p-8 rounded-xl shadow-2xl text-center max-w-lg w-full transform transition-all duration-300 hover:scale-105 border border-blue-200">
                <h1 className="text-4xl font-extrabold text-gray-800 mb-6 animate-fade-in-down">
                  Welcome to CBT Exam App
                </h1>
                <p className="text-lg text-gray-600 mb-8 leading-relaxed animate-fade-in">
                  This is a computer-based testing platform for your school.
                </p>
                <div className="space-y-4">
                  <button
                    onClick={() => setCurrentPage('admin')}
                    className="w-full px-6 py-3 bg-blue-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-300 ease-in-out transform hover:scale-105"
                  >
                    Login as Admin
                  </button>
                  <button
                    onClick={() => setCurrentPage('exam')}
                    className="w-full px-6 py-3 bg-green-500 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75 transition duration-300 ease-in-out transform hover:scale-105"
                  >
                    Take an Exam
                  </button>
                </div>
                <p className="text-sm text-gray-500 mt-8">
                  Your User ID: <span className="font-mono text-gray-700 break-all">{userId}</span>
                </p>
              </div>
            </div>
          );
        };

        // Admin Page Component
        const AdminPage = () => {
          const { db, appId, showModal, setCurrentPage } = React.useContext(AppContext);
          const [adminPasswordInput, setAdminPasswordInput] = React.useState('');
          const [isAdminAuthenticated, setIsAdminAuthenticated] = React.useState(false);

          const [questionText, setQuestionText] = React.useState('');
          const [options, setOptions] = React.useState(['', '', '', '']);
          const [correctOptionIndex, setCorrectOptionIndex] = React.useState(0);
          const [questions, setQuestions] = React.useState([]);
          const [loading, setLoading] = React.useState(true);
          const [bulkQuestionInput, setBulkQuestionInput] = React.useState('');
          const [aiQuestionTopic, setAiQuestionTopic] = React.useState('');
          const [isGeneratingAiQuestions, setIsGeneratingAiQuestions] = React.useState(false);
          const [studentScores, setStudentScores] = React.useState([]);
          const [loadingScores, setLoadingScores] = React.useState(true);


          // Authenticate admin
          const handleAdminLogin = () => {
            if (adminPasswordInput === ADMIN_PASSWORD) {
              setIsAdminAuthenticated(true);
              setAdminPasswordInput('');
            } else {
              showModal("Incorrect password. Please try again.", () => {});
            }
          };

          // Fetch questions from Firestore in real-time
          React.useEffect(() => {
            if (!db || !appId || !isAdminAuthenticated) return;

            const questionsCollectionRef = collection(db, `artifacts/${appId}/public/data/questions`);
            const unsubscribe = onSnapshot(questionsCollectionRef, (snapshot) => {
              const fetchedQuestions = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              setQuestions(fetchedQuestions);
              setLoading(false);
            }, (error) => {
              console.error("Error fetching questions:", error);
              showModal("An error occurred while fetching questions. Please try again.", () => {});
              setLoading(false);
            });

            return () => unsubscribe();
          }, [db, appId, isAdminAuthenticated, showModal]);

          // Fetch all student scores
          React.useEffect(() => {
            if (!db || !appId || !isAdminAuthenticated) return;

            const fetchAllStudentScores = async () => {
              setLoadingScores(true);
              const allScores = [];
              try {
                const usersCollectionRef = collection(db, `artifacts/${appId}/users`);
                const usersSnapshot = await getDocs(usersCollectionRef);

                for (const userDoc of usersSnapshot.docs) {
                  const userId = userDoc.id;
                  const examsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/exams`);
                  const examsSnapshot = await getDocs(examsCollectionRef);

                  examsSnapshot.docs.forEach(examDoc => {
                    allScores.push({
                      id: examDoc.id,
                      firebaseUid: userId,
                      ...examDoc.data()
                    });
                  });
                }
                allScores.sort((a, b) => (b.examDate?.seconds || 0) - (a.examDate?.seconds || 0));
                setStudentScores(allScores);
              } catch (error) {
                console.error("Error fetching all student scores:", error);
                showModal("An error occurred while fetching student scores. Please ensure your Firebase rules allow admin read access.", () => {});
              } finally {
                setLoadingScores(false);
              }
            };

            fetchAllStudentScores();

          }, [db, appId, isAdminAuthenticated, showModal]);


          // Handle adding a new question
          const handleAddQuestion = async () => {
            if (!questionText.trim() || options.some(opt => !opt.trim())) {
              showModal("Please fill in all question and option fields.", () => {});
              return;
            }

            try {
              const questionsCollectionRef = collection(db, `artifacts/${appId}/public/data/questions`);
              await addDoc(questionsCollectionRef, {
                questionText: questionText.trim(),
                options: options.map(opt => opt.trim()),
                correctOptionIndex: parseInt(correctOptionIndex),
                createdAt: new Date()
              });
              setQuestionText('');
              setOptions(['', '', '', '']);
              setCorrectOptionIndex(0);
              showModal("Question added successfully!", () => {});
            } catch (e) {
              console.error("Error adding document: ", e);
              showModal("An error occurred while adding the question. Please try again.", () => {});
            }
          };

          // Handle deleting a question
          const handleDeleteQuestion = async (id) => {
            showModal("Are you sure you want to delete this question?", async () => {
              try {
                const questionDocRef = doc(db, `artifacts/${appId}/public/data/questions`, id);
                await deleteDoc(questionDocRef);
                showModal("Question deleted successfully!", () => {});
              } catch (e) {
                console.error("Error deleting document: ", e);
                showModal("An error occurred while deleting the question. Please try again.", () => {});
              }
            }, true);
          };

          // Handle option change for single question add
          const handleOptionChange = (index, value) => {
            const newOptions = [...options];
            newOptions[index] = value;
            setOptions(newOptions);
          };

          // Parse bulk questions from pasted text
          const parseBulkQuestions = (text) => {
            const questionBlocks = text.split(/\n\s*\n/).filter(block => block.trim() !== '');
            const parsedQuestions = [];
            let errors = [];

            questionBlocks.forEach((block, blockIndex) => {
              const lines = block.split('\n').map(line => line.trim()).filter(line => line !== '');
              if (lines.length < 6) {
                errors.push(`Block ${blockIndex + 1}: Insufficient lines. Expected at least 6, got ${lines.length}.`);
                return;
              }

              const questionText = lines[0];
              const currentOptions = [];
              let correctIndex = -1;

              for (let i = 1; i <= 4; i++) {
                const optionLine = lines[i];
                const match = optionLine.match(/^([A-D])\.\s*(.*)/);
                if (match) {
                  currentOptions.push(match[2]);
                } else {
                  errors.push(`Block ${blockIndex + 1}: Option ${optionLetters[i-1]} format incorrect: "${optionLine}"`);
                  return;
                }
              }

              const correctLine = lines[5];
              const correctMatch = correctLine.match(/^Correct:\s*([A-D])/i);
              if (correctMatch) {
                correctIndex = optionLetters.indexOf(correctMatch[1].toUpperCase());
                if (correctIndex === -1) {
                  errors.push(`Block ${blockIndex + 1}: Invalid correct option letter: "${correctMatch[1]}". Must be A, B, C, or D.`);
                  return;
                }
              } else {
                errors.push(`Block ${blockIndex + 1}: Correct answer line format incorrect: "${correctLine}"`);
                return;
              }

              if (currentOptions.length === 4 && correctIndex !== -1) {
                parsedQuestions.push({
                  questionText,
                  options: currentOptions,
                  correctOptionIndex: correctIndex,
                  createdAt: new Date()
                });
              } else {
                errors.push(`Block ${blockIndex + 1}: Failed to parse all parts correctly.`);
              }
            });

            return { parsedQuestions, errors };
          };

          // Handle bulk adding questions
          const handleBulkAddQuestions = async () => {
            if (!bulkQuestionInput.trim()) {
              showModal("Please paste questions into the text area.", () => {});
              return;
            }

            const { parsedQuestions, errors } = parseBulkQuestions(bulkQuestionInput);

            if (errors.length > 0) {
              showModal(`Errors found in bulk input:\n${errors.join('\n')}`, () => {});
              return;
            }
            if (parsedQuestions.length === 0) {
              showModal("No valid questions found in the pasted text. Please check the format.", () => {});
              return;
            }

            showModal(`Are you sure you want to add ${parsedQuestions.length} questions?`, async () => {
              try {
                const questionsCollectionRef = collection(db, `artifacts/${appId}/public/data/questions`);
                const addPromises = parsedQuestions.map(q => addDoc(questionsCollectionRef, q));
                await Promise.all(addPromises);
                setBulkQuestionInput('');
                showModal(`${parsedQuestions.length} questions added successfully!`, () => {});
              } catch (e) {
                console.error("Error adding bulk documents: ", e);
                showModal("An error occurred while adding bulk questions. Please try again.", () => {});
              }
            }, true);
          };

          // Handle AI question generation
          const handleGenerateAiQuestions = async () => {
            if (!aiQuestionTopic.trim()) {
              showModal("Please enter a topic for AI question generation.", () => {});
              return;
            }

            setIsGeneratingAiQuestions(true);
            setBulkQuestionInput('');

            try {
              const prompt = `Generate 3 multiple-choice questions about "${aiQuestionTopic}". Each question must have exactly 4 options (A, B, C, D) and specify the correct option letter. Provide the output as a JSON array of objects, where each object has 'questionText' (string), 'options' (array of 4 strings), and 'correctOptionLetter' (string: 'A', 'B', 'C', or 'D').`;

              let chatHistory = [];
              chatHistory.push({ role: "user", parts: [{ text: prompt }] });
              const payload = {
                contents: chatHistory,
                generationConfig: {
                  responseMimeType: "application/json",
                  responseSchema: {
                    type: "ARRAY",
                    items: {
                      type: "OBJECT",
                      properties: {
                        "questionText": { "type": "STRING" },
                        "options": {
                          "type": "ARRAY",
                          "items": { "type": "STRING" },
                          "minItems": 4,
                          "maxItems": 4
                        },
                        "correctOptionLetter": { "type": "STRING", "enum": ["A", "B", "C", "D"] }
                      },
                      "required": ["questionText", "options", "correctOptionLetter"]
                    }
                  }
                }
              };

              const apiKey = "";
              const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

              const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });

              const result = await response.json();

              if (result.candidates && result.candidates.length > 0 &&
                  result.candidates[0].content && result.candidates[0].content.parts &&
                  result.candidates[0].content.parts.length > 0) {
                const jsonString = result.candidates[0].content.parts[0].text;
                const generatedQuestions = JSON.parse(jsonString);

                let formattedText = '';
                generatedQuestions.forEach(q => {
                  formattedText += `${q.questionText}\n`;
                  q.options.forEach((opt, idx) => {
                    formattedText += `${optionLetters[idx]}. ${opt}\n`;
                  });
                  formattedText += `Correct: ${q.correctOptionLetter}\n\n`;
                });
                setBulkQuestionInput(formattedText);
                showModal("AI questions generated! Review them in the 'Bulk Upload Questions' section and click 'Upload Questions' to add them.", () => {});

              } else {
                showModal("Failed to generate questions from AI. Please try a different topic or try again.", () => {});
              }

            } catch (error) {
              console.error("Error generating AI questions:", error);
              showModal("An error occurred during AI question generation. Please check your network or try again.", () => {});
            } finally {
              setIsGeneratingAiQuestions(false);
            }
          };


          if (!isAdminAuthenticated) {
            return (
              <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-purple-50 to-pink-100 p-4">
                <div className="bg-white p-8 rounded-xl shadow-2xl text-center max-w-md w-full border border-purple-200">
                  <h2 className="text-3xl font-extrabold text-gray-800 mb-6">Admin Login</h2>
                  <p className="text-gray-600 mb-6">Enter the admin password to proceed.</p>
                  <input
                    type="password"
                    className="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-purple-400 focus:border-transparent transition duration-200 ease-in-out"
                    value={adminPasswordInput}
                    onChange={(e) => setAdminPasswordInput(e.target.value)}
                    placeholder="Enter admin password"
                  />
                  <button
                    onClick={handleAdminLogin}
                    className="w-full px-6 py-3 bg-purple-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 transition duration-300 ease-in-out transform hover:scale-105"
                  >
                    Login
                  </button>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-100 p-4 sm:p-6 lg:p-8">
              <div className="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-2xl border border-purple-200">
                <div className="flex justify-between items-center mb-8">
                  <h2 className="text-3xl font-extrabold text-gray-800 text-center flex-grow">
                    Admin Panel - Add/Manage Questions & Scores
                  </h2>
                  <button
                    onClick={() => setCurrentPage('home')}
                    className="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition duration-200 ease-in-out text-sm"
                  >
                    Back to Home
                  </button>
                </div>

                {/* Add Single Question Form */}
                <div className="mb-12 p-6 bg-gray-50 rounded-xl shadow-inner border border-gray-200">
                  <h3 className="text-2xl font-bold text-gray-700 mb-6">Add New Question</h3>
                  <div className="space-y-4">
                    <div>
                      <label htmlFor="questionText" className="block text-gray-700 text-sm font-semibold mb-2">
                        Question Text:
                      </label>
                      <textarea
                        id="questionText"
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent transition duration-200 ease-in-out resize-y min-h-[80px]"
                        value={questionText}
                        onChange={(e) => setQuestionText(e.target.value)}
                        placeholder="Enter your question here..."
                      ></textarea>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {options.map((option, index) => (
                        <div key={index}>
                          <label htmlFor={`option-${index}`} className="block text-gray-700 text-sm font-semibold mb-2">
                            Option {optionLetters[index]}:
                          </label>
                          <input
                            type="text"
                            id={`option-${index}`}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent transition duration-200 ease-in-out"
                            value={option}
                            onChange={(e) => handleOptionChange(index, e.target.value)}
                            placeholder={`Enter option ${optionLetters[index]}`}
                          />
                        </div>
                      ))}
                    </div>
                    <div>
                      <label htmlFor="correctOption" className="block text-gray-700 text-sm font-semibold mb-2">
                        Correct Option:
                      </label>
                      <select
                        id="correctOption"
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent transition duration-200 ease-in-out bg-white"
                        value={correctOptionIndex}
                        onChange={(e) => setCorrectOptionIndex(e.target.value)}
                      >
                        {options.map((_, index) => (
                          <option key={index} value={index}>
                            Option {optionLetters[index]}
                          </option>
                        ))}
                      </select>
                    </div>
                    <button
                      onClick={handleAddQuestion}
                      className="w-full px-6 py-3 bg-purple-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 transition duration-300 ease-in-out transform hover:scale-105"
                    >
                      Add Question
                    </button>
                  </div>
                </div>

                {/* AI Question Generation Section ✨ */}
                <div className="mb-12 p-6 bg-blue-50 rounded-xl shadow-inner border border-blue-200">
                  <h3 className="text-2xl font-bold text-gray-700 mb-6">Generate Questions with AI ✨</h3>
                  <p className="text-gray-600 mb-4 text-sm">
                    Enter a topic, and AI will generate multiple-choice questions for you.
                  </p>
                  <input
                    type="text"
                    className="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 ease-in-out"
                    value={aiQuestionTopic}
                    onChange={(e) => setAiQuestionTopic(e.target.value)}
                    placeholder="e.g., 'History of Nigeria', 'Basic Algebra'"
                  />
                  <button
                    onClick={handleGenerateAiQuestions}
                    disabled={isGeneratingAiQuestions}
                    className={`w-full px-6 py-3 text-white text-lg font-semibold rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-300 ease-in-out transform hover:scale-105
                      ${isGeneratingAiQuestions ? 'bg-blue-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}`}
                  >
                    {isGeneratingAiQuestions ? 'Generating...' : 'Generate Questions'}
                  </button>
                  {isGeneratingAiQuestions && (
                    <p className="text-center text-blue-600 mt-4">AI is working, please wait...</p>
                  )}
                </div>


                {/* Bulk Upload Section */}
                <div className="mb-12 p-6 bg-gray-50 rounded-xl shadow-inner border border-gray-200">
                  <h3 className="text-2xl font-bold text-gray-700 mb-6">Bulk Upload Questions</h3>
                  <div className="text-gray-600 mb-4 text-sm">
                    Paste multiple questions here. Use the format:
                    <pre className="bg-gray-100 p-3 rounded-md mt-2 text-xs overflow-auto">
                      Question text?<br/>
                      A. Option A<br/>
                      B. Option B<br/>
                      C. Option C<br/>
                      D. Option D<br/>
                      Correct: B<br/>
                      <br/>
                      Question text 2?<br/>
                      A. Option A for Q2<br/>
                      ...
                    </pre>
                  </div>
                  <textarea
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent transition duration-200 ease-in-out resize-y min-h-[150px]"
                    value={bulkQuestionInput}
                    onChange={(e) => setBulkQuestionInput(e.target.value)}
                    placeholder="Paste your questions here in the specified format..."
                  ></textarea>
                  <button
                    onClick={handleBulkAddQuestions}
                    className="w-full mt-4 px-6 py-3 bg-indigo-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition duration-300 ease-in-out transform hover:scale-105"
                  >
                    Upload Questions
                  </button>
                </div>


                {/* Existing Questions List */}
                <div className="p-6 bg-white rounded-xl shadow-inner border border-gray-200">
                  <h3 className="text-2xl font-bold text-gray-700 mb-6">Existing Questions</h3>
                  {loading ? (
                    <p className="text-center text-gray-500">Loading questions...</p>
                  ) : questions.length === 0 ? (
                    <p className="text-center text-gray-500">No questions added yet.</p>
                  ) : (
                    <ul className="space-y-6">
                      {questions.map((q) => (
                        <li key={q.id} className="p-4 bg-purple-50 rounded-lg shadow-sm border border-purple-100">
                          <p className="font-semibold text-gray-800 mb-2">{q.questionText}</p>
                          <ul className="list-disc list-inside text-gray-700 mb-3">
                            {q.options.map((opt, idx) => (
                              <li key={idx} className={idx === q.correctOptionIndex ? 'font-bold text-green-700' : ''}>
                                {optionLetters[idx]}. {opt} {idx === q.correctOptionIndex && '(Correct)'}
                              </li>
                            ))}
                          </ul>
                          <button
                            onClick={() => handleDeleteQuestion(q.id)}
                            className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75 transition duration-200 ease-in-out text-sm"
                          >
                            Delete
                          </button>
                        </li>
                      ))}
                    </ul>
                  )}
                </div>

                {/* Student Scores Dashboard Section */}
                <div className="mt-12 p-6 bg-green-50 rounded-xl shadow-inner border border-green-200">
                  <h3 className="text-2xl font-bold text-gray-700 mb-6">Student Exam Scores</h3>
                  {loadingScores ? (
                    <p className="text-center text-gray-500">Loading student scores...</p>
                  ) : studentScores.length === 0 ? (
                    <p className="text-center text-gray-500">No student exam scores found yet.</p>
                  ) : (
                    <div className="overflow-x-auto">
                      <table className="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                          <tr className="bg-green-100 text-gray-700 uppercase text-sm leading-normal">
                            <th className="py-3 px-6 text-left">Student Name</th>
                            <th className="py-3 px-6 text-left">Student ID</th>
                            <th className="py-3 px-6 text-left">Score</th>
                            <th className="py-3 px-6 text-left">Total Questions</th>
                            <th className="py-3 px-6 text-left">Date</th>
                          </tr>
                        </thead>
                        <tbody className="text-gray-600 text-sm font-light">
                          {studentScores.map((score, index) => (
                            <tr key={index} className="border-b border-gray-200 hover:bg-gray-50">
                              <td className="py-3 px-6 text-left whitespace-nowrap">{score.studentName}</td>
                              <td className="py-3 px-6 text-left">{score.studentId}</td>
                              <td className="py-3 px-6 text-left font-medium">{score.score}</td>
                              <td className="py-3 px-6 text-left">{score.totalQuestions}</td>
                              <td className="py-3 px-6 text-left">
                                {score.examDate ? new Date(score.examDate.seconds * 1000).toLocaleString() : 'N/A'}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        };

        // Student Exam Page Component
        const StudentExamPage = () => {
          const { db, appId, showModal, setCurrentPage, userId } = React.useContext(AppContext);
          const [studentIdInput, setStudentIdInput] = React.useState('');
          const [studentNameInput, setStudentNameInput] = React.useState('');
          const [currentStudentId, setCurrentStudentId] = React.useState('');
          const [currentStudentName, setCurrentStudentName] = React.useState('');

          const [questions, setQuestions] = React.useState([]);
          const [currentQuestionIndex, setCurrentQuestionIndex] = React.useState(0);
          const [selectedAnswers, setSelectedAnswers] = React.useState({});
          const [examSubmitted, setExamSubmitted] = React.useState(false);
          const [score, setScore] = React.useState(0);
          const [loadingQuestions, setLoadingQuestions] = React.useState(true);
          const [examAlreadyTaken, setExamAlreadyTaken] = React.useState(false);


          // Fetch questions from Firestore in real-time
          React.useEffect(() => {
            if (!db || !appId) return;

            const questionsCollectionRef = collection(db, `artifacts/${appId}/public/data/questions`);
            const unsubscribe = onSnapshot(questionsCollectionRef, (snapshot) => {
              const fetchedQuestions = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              const shuffledQuestions = fetchedQuestions.sort(() => Math.random() - 0.5);
              setQuestions(shuffledQuestions);
              setLoadingQuestions(false);
            }, (error) => {
              console.error("Error fetching questions for exam:", error);
              showModal("An error occurred while fetching exam questions.", () => {});
              setLoadingQuestions(false);
            });

            return () => unsubscribe();
          }, [db, appId, showModal]);

          // Handle student ID and Name submission
          const handleStudentLogin = async () => {
            if (!studentIdInput.trim() || !studentNameInput.trim()) {
              showModal("Please enter both your Student ID and Name to start the exam.", () => {});
              return;
            }
            if (!userId || userId === 'loading...') {
              showModal("Firebase authentication not ready. Please wait a moment and try again.", () => {});
              return;
            }

            try {
              const studentExamsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/exams`);
              const q = query(studentExamsCollectionRef, where('studentId', '==', studentIdInput.trim()));
              const querySnapshot = await getDocs(q);

              if (!querySnapshot.empty) {
                setExamAlreadyTaken(true);
                showModal("You have already completed an exam with this ID. You cannot retake the exam.", () => {});
                return;
              }
            } catch (e) {
              console.error("Error checking for previous exams:", e);
              showModal("An error occurred while checking for previous exams. Please try again.", () => {});
              return;
            }

            setCurrentStudentId(studentIdInput.trim());
            setCurrentStudentName(studentNameInput.trim());
            setExamSubmitted(false);
            setSelectedAnswers({});
            setScore(0);
            setCurrentQuestionIndex(0);
            setExamAlreadyTaken(false);
          };

          // Handle selecting an answer option
          const handleOptionSelect = (questionId, optionIndex) => {
            setSelectedAnswers(prev => ({
              ...prev,
              [questionId]: optionIndex
            }));
          };

          // Navigate to the next question
          const handleNextQuestion = () => {
            if (currentQuestionIndex < questions.length - 1) {
              setCurrentQuestionIndex(prev => prev + 1);
            }
          };

          // Navigate to the previous question
          const handlePreviousQuestion = () => {
            if (currentQuestionIndex > 0) {
              setCurrentQuestionIndex(prev => prev - 1);
            }
          };

          // Submit the exam
          const handleSubmitExam = async () => {
            showModal("Are you sure you want to submit this exam? You cannot retake it once submitted.", async () => {
              let correctCount = 0;
              questions.forEach(q => {
                if (selectedAnswers[q.id] === q.correctOptionIndex) {
                  correctCount++;
                }
              });
              setScore(correctCount);

              try {
                if (!currentStudentId || !currentStudentName || !userId) {
                  showModal("Error: Student ID, Name, or User ID missing. Please re-enter your details.", () => {});
                  return;
                }

                const studentExamsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/exams`);
                await addDoc(studentExamsCollectionRef, {
                  studentId: currentStudentId,
                  studentName: currentStudentName,
                  examDate: new Date(),
                  score: correctCount,
                  totalQuestions: questions.length,
                  answers: questions.map(q => ({
                    questionId: q.id,
                    questionText: q.questionText,
                    options: q.options,
                    selectedOptionIndex: selectedAnswers[q.id] !== undefined ? selectedAnswers[q.id] : -1,
                    correctOptionIndex: q.correctOptionIndex,
                    isCorrect: selectedAnswers[q.id] === q.correctOptionIndex
                  }))
                });
                setExamSubmitted(true);
                showModal(`Exam submitted! You scored ${correctCount} out of ${questions.length}.`, () => {});
              } catch (e) {
                console.error("Error submitting exam: ", e);
                showModal("An error occurred while submitting your exam. Please try again.", () => {});
              }
            }, true);
          };

          const currentQuestion = questions[currentQuestionIndex];

          if (!currentStudentId) {
            return (
              <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-green-50 to-teal-100 p-4">
                <div className="bg-white p-8 rounded-xl shadow-2xl text-center max-w-md w-full border border-green-200">
                  <h2 className="text-3xl font-extrabold text-gray-800 mb-6">Enter Your Details</h2>
                  <p className="text-gray-600 mb-6">Please enter your Student ID and Name to begin the exam.</p>
                  <input
                    type="text"
                    className="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-green-400 focus:border-transparent transition duration-200 ease-in-out"
                    value={studentIdInput}
                    onChange={(e) => setStudentIdInput(e.target.value)}
                    placeholder="e.g., YourStudentID123"
                  />
                  <input
                    type="text"
                    className="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-green-400 focus:border-transparent transition duration-200 ease-in-out"
                    value={studentNameInput}
                    onChange={(e) => setStudentNameInput(e.target.value)}
                    placeholder="e.g., John Doe"
                  />
                  <button
                    onClick={handleStudentLogin}
                    className="w-full px-6 py-3 bg-green-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 transition duration-300 ease-in-out transform hover:scale-105"
                  >
                    Start Exam
                  </button>
                  {examAlreadyTaken && (
                     <p className="text-red-500 mt-4 text-sm">You have already completed an exam with this ID. You cannot retake it.</p>
                  )}
                </div>
              </div>
            );
          }

          if (loadingQuestions) {
            return (
              <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-green-50 to-teal-100">
                <p className="text-xl text-gray-700">Loading exam questions...</p>
              </div>
            );
          }

          if (questions.length === 0) {
            return (
              <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-green-50 to-teal-100">
                <div className="bg-white p-8 rounded-xl shadow-2xl text-center max-w-md w-full border border-green-200">
                  <h2 className="text-3xl font-extrabold text-gray-800 mb-4">No Questions Found</h2>
                  <p className="text-gray-600">Please contact the administrator to add questions.</p>
                  <button
                    onClick={() => setCurrentPage('home')}
                    className="mt-6 px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition duration-200 ease-in-out text-lg"
                  >
                    Back to Home
                  </button>
                </div>
              </div>
            );
          }

          if (examSubmitted) {
            return (
              <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-green-50 to-teal-100 p-4">
                <div className="bg-white p-8 rounded-xl shadow-2xl text-center max-w-lg w-full border border-green-200">
                  <h2 className="text-4xl font-extrabold text-gray-800 mb-6">Exam Completed!</h2>
                  <p className="text-2xl text-gray-700 mb-4">
                    You scored <span className="font-bold text-green-600">{score}</span> out of <span className="font-bold text-gray-800">{questions.length}</span>.
                  </p>
                  <p className="text-lg text-gray-600 mb-8">
                    Student Name: <span className="font-mono text-gray-700 break-all">{currentStudentName}</span><br/>
                    Student ID: <span className="font-mono text-gray-700 break-all">{currentStudentId}</span>
                  </p>
                  <button
                    onClick={() => {
                      setStudentIdInput('');
                      setStudentNameInput('');
                      setCurrentStudentId('');
                      setCurrentStudentName('');
                      setExamSubmitted(false);
                      setSelectedAnswers({});
                      setScore(0);
                      setCurrentQuestionIndex(0);
                      setCurrentPage('home');
                    }}
                    className="px-8 py-3 bg-blue-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-300 ease-in-out transform hover:scale-105"
                  >
                    Go Back to Home
                  </button>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-teal-50 to-lime-100 p-4 sm:p-6 lg:p-8">
              <div className="max-w-3xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-2xl border border-teal-200">
                <div className="flex justify-between items-center mb-6">
                  <h2 className="text-3xl font-extrabold text-gray-800 text-center flex-grow">
                    CBT Exam - Student: <span className="text-teal-600 break-all">{currentStudentName} ({currentStudentId})</span>
                  </h2>
                  <button
                    onClick={() => setCurrentPage('home')}
                    className="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition duration-200 ease-in-out text-sm"
                  >
                    Back to Home
                  </button>
                </div>

                {/* Question Counter */}
                <p className="text-right text-gray-600 text-lg mb-4 font-semibold">
                  Question {currentQuestionIndex + 1} of {questions.length}
                </p>

                {/* Current Question */}
                <div className="mb-8 p-6 bg-teal-50 rounded-xl shadow-inner border border-teal-100">
                  <p className="text-xl font-semibold text-gray-800 mb-4 leading-relaxed">
                    {currentQuestion.questionText}
                  </p>
                  <div className="space-y-3">
                    {currentQuestion.options.map((option, index) => (
                      <button
                        key={index}
                        onClick={() => handleOptionSelect(currentQuestion.id, index)}
                        className={`w-full text-left p-4 border rounded-lg transition duration-200 ease-in-out
                          ${selectedAnswers[currentQuestion.id] === index
                            ? 'bg-teal-600 text-white border-teal-700 shadow-md transform scale-105'
                            : 'bg-white text-gray-800 border-gray-300 hover:bg-gray-100 hover:border-teal-400'
                          }
                          focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-75`}
                      >
                        {optionLetters[index]}. {option}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Navigation Buttons */}
                <div className="flex justify-between items-center mt-8">
                  <button
                    onClick={handlePreviousQuestion}
                    disabled={currentQuestionIndex === 0}
                    className={`px-6 py-3 rounded-lg shadow-md text-lg font-semibold transition duration-300 ease-in-out
                      ${currentQuestionIndex === 0
                        ? 'bg-gray-300 text-gray-600 cursor-not-allowed'
                        : 'bg-blue-500 text-white hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 transform hover:scale-105'
                      }`}
                  >
                    Previous Question
                  </button>

                  {currentQuestionIndex === questions.length - 1 ? (
                    <button
                      onClick={handleSubmitExam}
                      className="px-8 py-3 bg-green-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 transition duration-300 ease-in-out transform hover:scale-105"
                    >
                      Submit Exam
                    </button>
                  ) : (
                    <button
                      onClick={handleNextQuestion}
                      className="px-6 py-3 bg-blue-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-300 ease-in-out transform hover:scale-105"
                    >
                      Next Question
                    </button>
                  )}
                </div>
              </div>
            </div>
          );
        };


        // Main App Component
        const App = () => {
          const [db, setDb] = React.useState(null);
          const [auth, setAuth] = React.useState(null);
          const [appId, setAppId] = React.useState('default-app-id');
          const [userId, setUserId] = React.useState('loading...');

          const [currentPage, setCurrentPage] = React.useState('home');

          const [modalMessage, setModalMessage] = React.useState('');
          const [modalOnConfirm, setModalOnConfirm] = React.useState(() => () => {});
          const [modalOnCancel, setModalOnCancel] = React.useState(() => () => {});
          const [modalShowCancel, setModalShowCancel] = React.useState(false);

          const showModal = (message, onConfirm, showCancel = false, onCancel = () => {}) => {
            setModalMessage(message);
            setModalOnConfirm(() => {
              return () => {
                onConfirm();
                setModalMessage('');
              };
            });
            setModalShowCancel(showCancel);
            setModalOnCancel(() => {
              return () => {
                onCancel();
                setModalMessage('');
              };
            });
          };

          React.useEffect(() => {
            try {
              // REPLACE THIS firebaseConfig OBJECT WITH YOUR ACTUAL FIREBASE PROJECT'S CONFIG
              const firebaseConfig = {
                apiKey: "YOUR_API_KEY_HERE",
                authDomain: "YOUR_AUTH_DOMAIN_HERE",
                projectId: "YOUR_PROJECT_ID_HERE",
                storageBucket: "YOUR_STORAGE_BUCKET_HERE",
                messagingSenderId: "YOUR_MESSAGING_SENDER_ID_HERE",
                appId: "YOUR_FIREBASE_APP_ID_HERE",
                // measurementId: "YOUR_MEASUREMENT_ID_HERE" // Include if present
              };

              const app = initializeApp(firebaseConfig);
              const firestore = getFirestore(app);
              const firebaseAuth = getAuth(app);

              setDb(firestore);
              setAuth(firebaseAuth);

              // Use projectId from your firebaseConfig as the appId for consistent paths in Firestore
              setAppId(firebaseConfig.projectId);

              const signIn = async () => {
                try {
                  // For local/hosted environment, we don't have __initial_auth_token.
                  // We sign in anonymously.
                  const userCredential = await signInAnonymously(firebaseAuth);
                  setUserId(userCredential.user.uid);
                } catch (error) {
                  console.error("Firebase authentication error:", error);
                  showModal("An error occurred while signing in to Firebase. Please try again.", () => {});
                }
              };
              signIn();

              const unsubscribeAuth = onAuthStateChanged(firebaseAuth, (user) => {
                if (user) {
                  setUserId(user.uid);
                } else {
                  setUserId('anonymous');
                }
              });

              return () => unsubscribeAuth();
            } catch (error) {
              console.error("Error initializing Firebase:", error);
              showModal("An error occurred while initializing Firebase. Please try again.", () => {});
            }
          }, []);


          const contextValue = {
            db,
            auth,
            appId,
            userId,
            setCurrentPage,
            showModal
          };

          return (
            <AppContext.Provider value={contextValue}>
              <div className="min-h-screen">
                {modalMessage && (
                  <Modal
                    message={modalMessage}
                    onConfirm={modalOnConfirm}
                    onCancel={modalOnCancel}
                    showCancel={modalShowCancel}
                  />
                )}
                {currentPage === 'home' && <HomePage />}
                {currentPage === 'admin' && <AdminPage />}
                {currentPage === 'exam' && <StudentExamPage />}
              </div>
            </AppContext.Provider>
          );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
