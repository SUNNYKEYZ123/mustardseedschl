<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/x-icon" href="https://sunnykeyz123.github.io/mustardseedschl/images/Logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mustard Seed CBT | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-[#f8fafc] text-slate-900">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, onSnapshot, query, where, setDoc, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDOO3uHmzOuAxJcdLxu-OImzlH12A6FpeY",
            authDomain: "my-project-a6208.firebaseapp.com",
            projectId: "my-project-a6208",
            storageBucket: "my-project-a6208.firebasestorage.app",
            messagingSenderId: "784486701962",
            appId: "1:784486701962:web:0d3cd002bbfd647e944673"
        };

        const app = initializeApp(firebaseConfig);
        window.fb = {
            db: getFirestore(app),
            auth: getAuth(app),
            collection, addDoc, getDocs, doc, deleteDoc, onSnapshot, query, where, signInAnonymously, onAuthStateChanged, setDoc, writeBatch, serverTimestamp
        };
    </script>

    <script type="text/babel">
        const { createClient } = window.supabase;
        const SB_URL = 'https://jqrcoqslmylmubxwfgyt.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpxcmNvcXNsbXlsmubxwfgytIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2ODc2NzgsImV4cCI6MjA4MDI2MzY3OH0.4bXOY35R3eGYZjPxtuJzvwifPEfHXr5UEdzFbB-caKU';
        const _supabase = createClient(SB_URL, SB_KEY);

        const AppContext = React.createContext(null);
        const ADMIN_PASSWORD = 'SUNNYKEYZ2025@';
        const optionLetters = ['A', 'B', 'C', 'D'];

        // --- ADMIN PAGE ---
        const AdminPage = () => {
            const { setPage } = React.useContext(AppContext);
            const [auth, setAuth] = React.useState(false);
            const [pass, setPass] = React.useState('');
            const [scores, setScores] = React.useState([]);
            const [questions, setQuestions] = React.useState([]);
            const [newQ, setNewQ] = React.useState({ text: '', options: ['', '', '', ''], correct: 0 });
            const [examLive, setExamLive] = React.useState(false);

            React.useEffect(() => {
                if (!auth) return;
                const qScores = fb.query(fb.collection(fb.db, "artifacts/my-project-a6208/scores"));
                const qQuest = fb.query(fb.collection(fb.db, "artifacts/my-project-a6208/public/data/questions"));
                const statusRef = fb.doc(fb.db, "artifacts/my-project-a6208/settings/examControl");
                
                const unsub1 = fb.onSnapshot(qScores, (s) => {
                    const data = s.docs.map(d => ({id: d.id, ...d.data()}));
                    data.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                    setScores(data);
                });
                const unsub2 = fb.onSnapshot(qQuest, (s) => setQuestions(s.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsub3 = fb.onSnapshot(statusRef, (doc) => {
                    if (doc.exists()) setExamLive(doc.data().isLive);
                });

                return () => { unsub1(); unsub2(); unsub3(); };
            }, [auth]);

            const deleteAllScores = async () => {
                if(!confirm("âš ï¸ DANGER: This will delete ALL student results forever. Continue?")) return;
                const batch = fb.writeBatch(fb.db);
                scores.forEach(s => batch.delete(fb.doc(fb.db, "artifacts/my-project-a6208/scores", s.id)));
                await batch.commit();
                alert("Results wiped successfully.");
            };

            const toggleExam = async () => {
                const statusRef = fb.doc(fb.db, "artifacts/my-project-a6208/settings/examControl");
                await fb.setDoc(statusRef, { isLive: !examLive }, { merge: true });
            };

            const addQuestion = async () => {
                if(!newQ.text) return alert("Enter question text");
                await fb.addDoc(fb.collection(fb.db, "artifacts/my-project-a6208/public/data/questions"), {
                    questionText: newQ.text, options: newQ.options, correctOptionIndex: parseInt(newQ.correct)
                });
                setNewQ({ text: '', options: ['', '', '', ''], correct: 0 });
            };

            const deleteQuestion = async (id) => {
                if(confirm("Delete?")) await fb.deleteDoc(fb.doc(fb.db, "artifacts/my-project-a6208/public/data/questions", id));
            };

            const deleteScore = async (id) => {
                if (confirm("Delete this score?")) await fb.deleteDoc(fb.doc(fb.db, "artifacts/my-project-a6208/scores", id));
            };

            if (!auth) return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-[#0f172a] p-6 text-center">
                    <div className="bg-white p-10 rounded-3xl shadow-2xl w-full max-w-md">
                        <h2 className="text-3xl font-black mb-2">Admin Login</h2>
                        <input type="password" placeholder="Admin Key" className="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl mb-4 outline-none" onChange={e => setPass(e.target.value)} />
                        <button onClick={() => pass === ADMIN_PASSWORD ? setAuth(true) : alert("Wrong Key")} className="w-full bg-blue-600 text-white py-4 rounded-2xl font-black">LOGIN</button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen pb-20">
                    <div className="bg-white border-b sticky top-0 z-10 px-6 py-4 flex justify-between items-center shadow-sm">
                        <h1 className="font-black text-xl tracking-tighter uppercase">Admin Panel</h1>
                        <button onClick={() => setPage('home')} className="bg-slate-100 px-6 py-2 rounded-full font-bold text-sm">Logout</button>
                    </div>

                    <div className="p-6 max-w-6xl mx-auto space-y-6">
                        <div className={`p-8 rounded-[2rem] border-2 flex flex-col md:flex-row justify-between items-center ${examLive ? 'bg-emerald-50 border-emerald-100' : 'bg-rose-50 border-rose-100'}`}>
                            <div>
                                <h2 className="text-3xl font-black">Exam Control</h2>
                                <p className="font-bold">Status: {examLive ? "ACTIVE" : "SHUTDOWN"}</p>
                            </div>
                            <button onClick={toggleExam} className={`px-12 py-5 rounded-2xl font-black text-white ${examLive ? 'bg-rose-600 shadow-rose-200' : 'bg-emerald-600 shadow-emerald-200'} shadow-xl`}>
                                {examLive ? "SHUTDOWN EXAM" : "LAUNCH EXAM"}
                            </button>
                        </div>

                        <div className="bg-white rounded-[2rem] shadow-sm border overflow-hidden">
                            <div className="p-8 border-b flex justify-between items-center">
                                <h3 className="text-xl font-black">Student Performance</h3>
                                <button onClick={deleteAllScores} className="bg-rose-500 text-white px-5 py-2 rounded-xl text-xs font-black">DELETE ALL RESULTS</button>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-slate-50 text-[10px] font-black text-slate-400 uppercase">
                                        <tr>
                                            <th className="px-8 py-4 text-left">Candidate</th>
                                            <th className="px-8 py-4 text-center">Score</th>
                                            <th className="px-8 py-4 text-center">Accuracy</th>
                                            <th className="px-8 py-4 text-right">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-50">
                                        {scores.map(s => (
                                            <tr key={s.id}>
                                                <td className="px-8 py-6 font-black uppercase text-sm">{s.studentName}<br/><span className="text-[10px] text-slate-400">{s.studentId}</span></td>
                                                <td className="px-8 py-6 text-center text-lg font-black text-blue-600">{s.score}%</td>
                                                <td className="px-8 py-6 text-center text-xs font-bold text-slate-500">{s.correctAnswers}/{s.totalQuestions}</td>
                                                <td className="px-8 py-6 text-right"><button onClick={() => deleteScore(s.id)} className="text-rose-400 text-[10px] font-black uppercase">Remove</button></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div className="grid md:grid-cols-2 gap-6">
                            <div className="bg-white p-8 rounded-[2rem] border">
                                <h3 className="text-xl font-black mb-4">Add Question</h3>
                                <textarea className="w-full p-4 bg-slate-50 rounded-2xl mb-4 h-32 outline-none" value={newQ.text} onChange={e => setNewQ({...newQ, text: e.target.value})} placeholder="Question text..."></textarea>
                                <div className="grid grid-cols-2 gap-2 mb-4">
                                    {newQ.options.map((opt, i) => (
                                        <input key={i} className="p-3 bg-slate-50 rounded-xl text-sm border" placeholder={`Option ${optionLetters[i]}`} value={opt} onChange={e => {
                                            const copy = [...newQ.options]; copy[i] = e.target.value; setNewQ({...newQ, options: copy});
                                        }} />
                                    ))}
                                </div>
                                <div className="flex justify-between items-center">
                                    <select className="bg-slate-100 p-3 rounded-xl font-bold" value={newQ.correct} onChange={e => setNewQ({...newQ, correct: e.target.value})}>
                                        {optionLetters.map((l, i) => <option key={i} value={i}>Correct: {l}</option>)}
                                    </select>
                                    <button onClick={addQuestion} className="bg-slate-900 text-white px-8 py-3 rounded-xl font-black">Save</button>
                                </div>
                            </div>
                            <div className="bg-white p-8 rounded-[2rem] border h-96 overflow-y-auto">
                                <h3 className="text-xl font-black mb-4 uppercase">Question Bank ({questions.length})</h3>
                                {questions.map((q, i) => (
                                    <div key={q.id} className="p-3 bg-slate-50 rounded-xl mb-2 flex justify-between items-center">
                                        <span className="text-xs font-bold truncate pr-4">{i+1}. {q.questionText}</span>
                                        <button onClick={() => deleteQuestion(q.id)} className="text-rose-500 font-black">âœ•</button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- STUDENT PAGE ---
        const StudentExamPage = () => {
            const { setPage } = React.useContext(AppContext);
            const [isLive, setIsLive] = React.useState(null);
            const [msId, setMsId] = React.useState('');
            const [student, setStudent] = React.useState(null);
            const [questions, setQuestions] = React.useState([]);
            const [index, setIndex] = React.useState(0);
            const [answers, setAnswers] = React.useState({});
            const [loading, setLoading] = React.useState(false);
            const [finished, setFinished] = React.useState(false);
            const [finalScore, setFinalScore] = React.useState(0);

            React.useEffect(() => {
                const statusRef = fb.doc(fb.db, "artifacts/my-project-a6208/settings/examControl");
                return fb.onSnapshot(statusRef, (doc) => {
                    setIsLive(doc.exists() ? doc.data().isLive : false);
                });
            }, []);

            const verifyId = async () => {
                setLoading(true);
                const inputId = msId.toUpperCase().trim();
                try {
                    const { data } = await _supabase.from('students').select('*').eq('status', 'Enrolled');
                    const found = data?.find(s => ("MS-" + s.id.substring(0, 5).toUpperCase()) === inputId);
                    if (found) {
                        const scoreSnap = await fb.getDocs(fb.query(fb.collection(fb.db, "artifacts/my-project-a6208/scores"), fb.where("studentId", "==", inputId)));
                        if (!scoreSnap.empty) { alert("Already Submitted."); setLoading(false); return; }
                        setStudent({ name: found.full_name, id: inputId });
                        const snap = await fb.getDocs(fb.collection(fb.db, "artifacts/my-project-a6208/public/data/questions"));
                        setQuestions(snap.docs.map(d => ({id: d.id, ...d.data()})));
                    } else alert("ID Not Found");
                } catch (e) { alert(e.message); }
                setLoading(false);
            };

            const finishExam = async () => {
                if(!confirm("Submit Exam?")) return;
                let correctCount = 0;
                questions.forEach((q, i) => { if (answers[i] === q.correctOptionIndex) correctCount++; });
                const pct = Math.round((correctCount / questions.length) * 100);
                setFinalScore(pct);
                await fb.addDoc(fb.collection(fb.db, "artifacts/my-project-a6208/scores"), {
                    studentName: student.name, studentId: student.id, score: pct, 
                    correctAnswers: correctCount, totalQuestions: questions.length, timestamp: fb.serverTimestamp()
                });
                setFinished(true);
            };

            if (isLive === null) return <div className="p-20 text-center font-black animate-pulse">CONNECTING...</div>;
            
            // IF EXAM IS SHUTDOWN
            if (isLive === false) return (
                <div className="flex items-center justify-center min-h-screen bg-[#0f172a] p-6 text-center">
                    <div className="bg-white p-12 rounded-[3rem] shadow-2xl max-w-md">
                        <div className="text-6xl mb-6">ðŸ”’</div>
                        <h1 className="text-2xl font-black mb-4">EXAM NOT STARTED OR COMPLETED</h1>
                        <p className="text-slate-500 font-bold mb-8">The session is currently offline. Your results are secure. Stay at rest and wait for instructions.</p>
                        <button onClick={() => setPage('home')} className="w-full bg-slate-900 text-white py-4 rounded-2xl font-black">Go Back</button>
                    </div>
                </div>
            );

            if (finished) return (
                <div className="flex items-center justify-center min-h-screen bg-emerald-50 text-center p-6">
                    <div className="bg-white p-12 rounded-[3rem] shadow-2xl max-w-md border-4 border-emerald-100">
                        <h1 className="text-3xl font-black mb-4">WELL DONE!</h1>
                        <div className="bg-emerald-500 text-white p-8 rounded-3xl mb-4"><h2 className="text-6xl font-black">{finalScore}%</h2></div>
                        <p className="font-black uppercase">{student.name}</p>
                        <button onClick={() => setPage('home')} className="mt-8 w-full bg-slate-900 text-white py-4 rounded-2xl font-black">EXIT</button>
                    </div>
                </div>
            );

            if (!student) return (
                <div className="flex items-center justify-center min-h-screen bg-blue-50 p-6">
                    <div className="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-sm">
                        <h2 className="text-3xl font-black mb-8 text-center">Student Login</h2>
                        <input className="w-full p-5 bg-slate-50 border-2 rounded-2xl mb-4 uppercase font-bold outline-none focus:border-blue-600" placeholder="MS-XXXXX" onChange={e => setMsId(e.target.value)} />
                        <button onClick={verifyId} className="w-full py-5 bg-blue-600 text-white rounded-2xl font-black shadow-lg">{loading ? "Verifying..." : "START EXAM"}</button>
                    </div>
                </div>
            );

            return (
                <div className="max-w-2xl mx-auto p-6 pt-16">
                    <div className="fixed top-0 left-0 w-full h-2 bg-slate-100">
                        <div className="h-full bg-blue-600 transition-all" style={{ width: `${((index + 1) / questions.length) * 100}%` }}></div>
                    </div>
                    <div className="flex justify-between items-end mb-8 border-b pb-6">
                        <div><p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Candidate</p><h2 className="text-2xl font-black uppercase">{student.name}</h2></div>
                        <div className="bg-slate-900 text-white px-5 py-2 rounded-2xl font-black text-sm">{index + 1} OF {questions.length}</div>
                    </div>
                    {questions[index] && (
                        <div className="bg-white p-10 rounded-[3rem] shadow-xl border">
                            <p className="text-2xl font-black mb-10 text-slate-800 leading-snug">{questions[index].questionText}</p>
                            <div className="space-y-4">
                                {questions[index].options.map((opt, i) => (
                                    <button key={i} onClick={() => setAnswers({...answers, [index]: i})} className={`w-full p-6 text-left rounded-2xl border-2 font-bold transition-all ${answers[index] === i ? 'bg-blue-600 text-white border-blue-600 shadow-xl' : 'bg-slate-50 border-slate-50'}`}>
                                        <span className="mr-4 opacity-50">{optionLetters[i]}.</span> {opt}
                                    </button>
                                ))}
                            </div>
                            <div className="mt-12 flex justify-between gap-4">
                                <button onClick={() => setIndex(i => i - 1)} disabled={index === 0} className="px-6 font-black text-slate-400 disabled:opacity-0">Back</button>
                                {index === questions.length - 1 ? 
                                    <button onClick={finishExam} className="bg-emerald-500 text-white px-12 py-4 rounded-2xl font-black uppercase">Finish</button> :
                                    <button onClick={() => setIndex(i => i + 1)} className="bg-slate-900 text-white px-12 py-4 rounded-2xl font-black uppercase">Next</button>
                                }
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [page, setPage] = React.useState('home');
            const [ready, setReady] = React.useState(false);

            React.useEffect(() => {
                const i = setInterval(() => { if(window.fb) { setReady(true); clearInterval(i); }}, 100);
            }, []);

            if (!ready) return <div className="flex items-center justify-center min-h-screen font-black text-slate-300 uppercase tracking-[0.5em]">System Starting...</div>;

            return (
                <AppContext.Provider value={{ setPage }}>
                    {page === 'home' && (
                        <div className="flex flex-col items-center justify-center min-h-screen text-center p-6">
                            <div className="w-24 h-24 bg-blue-600 rounded-[2rem] flex items-center justify-center text-white text-5xl font-black mb-10 shadow-2xl">M</div>
                            <h1 className="text-6xl font-black mb-4 tracking-tighter">MUSTARD SEED</h1>
                            <p className="text-slate-400 font-bold uppercase mb-12 text-xs tracking-[0.3em]">Computer Based Testing</p>
                            <div className="flex flex-col md:flex-row gap-4 w-full max-w-md">
                                <button onClick={() => setPage('exam')} className="flex-1 bg-blue-600 text-white px-12 py-5 rounded-2xl font-black shadow-xl hover:scale-105 transition">ENTER PORTAL</button>
                                <button onClick={() => setPage('admin')} className="bg-white text-slate-400 px-12 py-5 rounded-2xl font-black border-2 hover:bg-slate-50 transition">ADMIN</button>
                            </div>
                        </div>
                    )}
                    {page === 'exam' && <StudentExamPage />}
                    {page === 'admin' && <AdminPage />}
                </AppContext.Provider>
            );
        };
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
